<!DOCTYPE html>
<html>
<head>
    <title>–¢–∞–ø–∞–ª–∫–∞ AIR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: #0a0f1e;
            color: white;
            text-align: center;
            padding-top: 30px;
            font-family: Arial, sans-serif;
            margin: 0;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* –®–ê–ü–ö–ê –° –ö–ù–û–ü–ö–û–ô –ú–ï–ù–Æ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #0a0f1e;
            z-index: 100;
            border-bottom: 1px solid #1a2a3a;
        }
        
        .menu-button {
            font-size: 32px;
            cursor: pointer;
            user-select: none;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: #1a2a3a;
            transition: 0.1s;
        }
        .menu-button:active {
            background: #2a3a4a;
            transform: scale(0.95);
        }
        
        .placeholder {
            width: 50px;
        }
        
        /* –í–´–ü–ê–î–ê–Æ–©–ï–ï –ú–ï–ù–Æ */
        .dropdown-menu {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a2a3a;
            border-radius: 16px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            border: 1px solid #2a3a4a;
        }
        .dropdown-menu.active {
            display: block;
        }
        
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: 0.1s;
            text-align: left;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .menu-item:hover {
            background: #2a3a4a;
        }
        .menu-item:active {
            background: #3a4a5a;
        }
        
        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ */
        .content {
            margin-top: 80px;
        }
        
        h1 {
            font-size: 48px;
            margin-bottom: 30px;
            color: #ffffff;
            text-shadow: 0 0 10px #00a8ff;
        }
        
        .friends-top-button {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            background: #00a8ff;
            color: white;
            padding: 12px 35px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 8px 0 #0077b3;
            border: none;
            transition: 0.1s;
            margin: 20px 0 15px 0;
            letter-spacing: 2px;
        }
        .friends-top-button:active {
            transform: scale(0.92);
            box-shadow: 0 4px 0 #0077b3;
        }
        
        #user-info {
            font-size: 18px;
            color: #88ff88;
            background: #1a2a3a;
            padding: 12px 25px;
            border-radius: 50px;
            display: inline-block;
            border: 1px solid #44aa44;
            font-weight: 500;
            margin-bottom: 30px;
        }
        
        #score {
            font-size: 64px;
            margin: 30px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 20px #ffaa00;
        }
        
        .tap-button {
            font-size: 80px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            background: #00a8ff;
            color: white;
            padding: 30px 50px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 20px;
            box-shadow: 0 12px 0 #0077b3;
            border: none;
            transition: transform 0.05s;
        }
        .tap-button:active {
            transform: scale(0.9);
            box-shadow: 0 6px 0 #0077b3;
        }
        
        .buttons-container {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 0 20px;
        }
        
        .action-button {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            background: #00a8ff;
            color: white;
            padding: 12px 30px;
            border-radius: 40px;
            display: inline-block;
            box-shadow: 0 8px 0 #0077b3;
            border: none;
            width: fit-content;
        }
        .action-button:active {
            transform: scale(0.92);
            box-shadow: 0 4px 0 #0077b3;
        }
        
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0f1e;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding-top: 30px;
            overflow-y: auto;
        }
        .screen.active {
            display: flex;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 40px;
            cursor: pointer;
            color: white;
            background: #ff4444;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 0 #aa2222;
        }
        
        .card {
            background: #1a2a3a;
            border-radius: 30px;
            padding: 25px 20px;
            margin: 15px;
            width: 85%;
            max-width: 400px;
            border: 2px solid #ffd700;
        }
        .card-title {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .leaderboard-table {
            width: 100%;
            margin-top: 20px;
        }
        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: #0f1a1f;
            margin: 5px 0;
            border-radius: 12px;
            border-left: 4px solid transparent;
        }
        .leaderboard-row.top-1 {
            border-left-color: gold;
        }
        .leaderboard-rank {
            font-weight: bold;
            color: #ffd700;
            width: 40px;
        }
        .leaderboard-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
        }
        .leaderboard-score {
            font-weight: bold;
            color: #88ff88;
        }
        .current-player {
            background: #1a3a4a;
            border: 1px solid #00a8ff;
        }
        .loading {
            color: #00a8ff;
            padding: 20px;
        }
        
        .gold-button {
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(145deg, #ffd700, #ffb700);
            color: #1a2a3a;
            padding: 15px 25px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: 0 8px 0 #b87c00;
            border: none;
            width: 80%;
            max-width: 280px;
            margin: 8px auto;
            text-decoration: none;
        }
        .gold-button:active {
            transform: scale(0.95);
        }
        .blue-button {
            background: linear-gradient(145deg, #00a8ff, #0077b3);
            box-shadow: 0 8px 0 #005580;
        }
        .reward-text {
            font-size: 18px;
            color: #88ff88;
            margin-top: 15px;
            padding: 10px;
            background: #0f1a1f;
            border-radius: 20px;
        }
        .timer {
            font-size: 20px;
            color: #ffaa00;
            margin-top: 10px;
            font-weight: bold;
        }
        .referral-link {
            background: #0a1a1f;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #00a8ff;
            color: #00a8ff;
            font-size: 14px;
            word-break: break-all;
            margin: 15px 0;
        }
        .counter {
            font-size: 48px;
            color: #ffd700;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="placeholder"></div>
        <div class="menu-button" onclick="toggleMenu()">‚ò∞</div>
    </div>
    
    <div id="dropdownMenu" class="dropdown-menu">
        <div class="menu-item" onclick="openLeaderboard(); toggleMenu();">
            üèÜ Leaderboards
        </div>
    </div>
    
    <div class="content">
        <h1>‚úàÔ∏è TAP AIR</h1>
        <div class="friends-top-button" onclick="openFriends()">üë• –î—Ä—É–∑—å—è</div>
        <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="score">0</div>
        <div class="tap-button" id="tapButton">AIR</div>
    </div>

    <div class="buttons-container">
        <div class="action-button" onclick="openBonuses()">üéÅ –ë–æ–Ω—É—Å—ã</div>
    </div>

    <!-- –≠–ö–†–ê–ù –ë–û–ù–£–°–û–í -->
    <div id="bonusScreen" class="screen">
        <div class="close-button" onclick="closeBonuses()">‚úï</div>
        <div class="card">
            <div class="card-title">üìÖ –ï–ñ–ï–î–ù–ï–í–ù–´–ô</div>
            <div class="card-description">+100 AIR –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</div>
            <button class="gold-button blue-button" onclick="claimDailyBonus()" id="dailyButton">üéÅ –ó–∞–±—Ä–∞—Ç—å</button>
            <div id="dailyStatus" class="reward-text">‚ú® –ù–∞–≥—Ä–∞–¥–∞: 100 AIR</div>
            <div id="dailyTimer" class="timer"></div>
        </div>
        <div class="card">
            <div class="card-title">üì¢ –ü–û–î–ü–ò–®–ò–°–¨</div>
            <div class="card-description">+5000 AIR –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É</div>
            <a href="https://t.me/air_coinb" class="gold-button" target="_blank">üîó –ü–µ—Ä–µ–π—Ç–∏</a>
            <button class="gold-button blue-button" onclick="claimChannelBonus()">üéÅ –ü–æ–ª—É—á–∏—Ç—å 5000</button>
            <div id="channelBonusStatus" class="reward-text">üéÅ –ù–∞–≥—Ä–∞–¥–∞: 5000 AIR</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –î–†–£–ó–ï–ô -->
    <div id="friendsScreen" class="screen">
        <div class="close-button" onclick="closeFriends()">‚úï</div>
        <div class="card">
            <div class="card-title">üë• –ü–†–ò–ì–õ–ê–®–ê–ô –î–†–£–ó–ï–ô</div>
            <div class="card-description">+500 AIR –∑–∞ 5 –¥—Ä—É–∑–µ–π</div>
            <div><span>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ:</span><div id="referralCount" class="counter">0</div></div>
            <div id="progressToNextBonus"></div>
            <div id="referralLink" class="referral-link"></div>
            <button class="gold-button blue-button" onclick="copyReferralLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="rewardsHistory"></div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –õ–ò–î–ï–†–û–í -->
    <div id="leaderboardScreen" class="screen">
        <div class="close-button" onclick="closeLeaderboard()">‚úï</div>
        <div class="card">
            <div class="card-title">üèÜ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</div>
            <div id="leaderboardList" class="leaderboard-table"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            <div id="playerRank" class="leaderboard-row current-player"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001';
        const BOT_USERNAME = '—Ç–≤–æ–π_–±–æ—Ç_bot';

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const initData = window.Telegram.WebApp.initDataUnsafe;
        const userId = initData.user?.id;
        const userName = initData.user?.first_name || "–ò–≥—Ä–æ–∫";
        const userUsername = initData.user?.username;

        if (userId) {
            document.getElementById('user-info').innerHTML = `üÜî –¢–≤–æ–π ID: <strong>${userId}</strong> ¬∑ üë§ ${userName}`;
        } else {
            document.getElementById('user-info').innerHTML = `‚ö†Ô∏è –ó–∞–ø—É—Å—Ç–∏ –≤ Telegram –±–æ—Ç–∞`;
        }

        const storageKey = userId ? "tap_score_" + userId : "tap_score_guest";
        const channelBonusKey = userId ? "bonus_channel_" + userId : "bonus_channel_guest";
        const dailyTimeKey = userId ? "daily_time_" + userId : "daily_time_guest";
        const referralCountKey = userId ? "referral_count_" + userId : "referral_count_guest";
        const referralRewardsKey = userId ? "referral_rewards_" + userId : "referral_rewards_guest";

        let savedScore = localStorage.getItem(storageKey);
        let count = savedScore ? parseInt(savedScore) : 0;
        document.getElementById('score').innerText = count;

        const tapButton = document.getElementById('tapButton');
        let tapLock = false;
        
        function processTap() {
            if (tapLock) return;
            tapLock = true;
            count++;
            document.getElementById('score').innerText = count;
            localStorage.setItem(storageKey, count);
            updateScoreOnServer();
            tg.HapticFeedback.impactOccurred('medium');
            setTimeout(() => { tapLock = false; }, 50);
        }

        tapButton.addEventListener('click', processTap);
        tapButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.touches.length; i++) {
                setTimeout(() => { processTap(); }, i * 20);
            }
        }, { passive: false });

        let updateTimeout;
        function updateScoreOnServer() {
            if (!userId) return;
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                fetch(`${API_BASE_URL}/api/update-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId.toString(),
                        username: userUsername,
                        first_name: userName,
                        score: count
                    })
                }).catch(err => console.error(err));
            }, 5000);
        }

        function toggleMenu() {
            document.getElementById('dropdownMenu').classList.toggle('active');
            tg.HapticFeedback.impactOccurred('light');
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('dropdownMenu');
            const btn = document.querySelector('.menu-button');
            if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.remove('active');
        });

        async function openLeaderboard() {
            document.getElementById('leaderboardScreen').classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
            await loadLeaderboard();
            await loadPlayerRank();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardScreen').classList.remove('active');
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/leaderboard`);
                const players = await res.json();
                if (!players.length) {
                    list.innerHTML = '<div>–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
                    return;
                }
                let html = '';
                players.forEach((p, i) => {
                    const cls = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
                    const name = p.first_name || p.username || `Player ${p.user_id.slice(-4)}`;
                    html += `<div class="leaderboard-row ${cls}"><span class="leaderboard-rank">#${i+1}</span><span class="leaderboard-name">${name}</span><span class="leaderboard-score">${p.score}</span></div>`;
                });
                list.innerHTML = html;
            } catch {
                list.innerHTML = '<div style="color:#ff8888;">–û—à–∏–±–∫–∞</div>';
            }
        }

        async function loadPlayerRank() {
            if (!userId) return;
            const rankDiv = document.getElementById('playerRank');
            try {
                const res = await fetch(`${API_BASE_URL}/api/player-rank/${userId}`);
                const data = await res.json();
                if (data.rank) rankDiv.innerHTML = `<span class="leaderboard-rank">#${data.rank}</span><span class="leaderboard-name">${userName}</span><span class="leaderboard-score">${data.score}</span>`;
                else rankDiv.innerHTML = '–¢—ã –ø–æ–∫–∞ –Ω–µ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ';
            } catch {
                rankDiv.innerHTML = '–û—à–∏–±–∫–∞';
            }
        }

        function claimDailyBonus() {
            const last = localStorage.getItem(dailyTimeKey);
            const now = Date.now();
            const day = 86400000;
            if (last && (now - parseInt(last)) < day) {
                const left = day - (now - parseInt(last));
                const h = Math.floor(left / 3600000);
                const m = Math.floor((left % 3600000) / 60000);
                tg.showAlert(`‚è≥ –ë–æ–Ω—É—Å —á–µ—Ä–µ–∑ ${h}—á ${m}–º`);
                return;
            }
            count += 100;
            document.getElementById('score').innerText = count;
            localStorage.setItem(storageKey, count);
            localStorage.setItem(dailyTimeKey, now.toString());
            updateDailyBonusUI();
            updateScoreOnServer();
            tg.showAlert('üéâ +100 AIR!');
        }

        function updateDailyBonusUI() {
            const last = localStorage.getItem(dailyTimeKey);
            const now = Date.now();
            const day = 86400000;
            const btn = document.getElementById('dailyButton');
            const status = document.getElementById('dailyStatus');
            const timer = document.getElementById('dailyTimer');
            if (!btn) return;
            if (last && (now - parseInt(last)) < day) {
                const left = day - (now - parseInt(last));
                const h = Math.floor(left / 3600000);
                const m = Math.floor((left % 3600000) / 60000);
                const s = Math.floor((left % 60000) / 1000);
                btn.disabled = true;
                btn.style.opacity = '0.5';
                status.innerHTML = '‚úÖ –ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω';
                timer.innerHTML = `‚è≥ ${h}—á ${m}–º ${s}—Å`;
                setTimeout(updateDailyBonusUI, 1000);
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                status.innerHTML = '‚ú® –ù–∞–≥—Ä–∞–¥–∞: 100 AIR';
                timer.innerHTML = '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω';
            }
        }

        function claimChannelBonus() {
            if (localStorage.getItem(channelBonusKey) === 'claimed') {
                tg.showAlert('‚ùå –£–∂–µ –ø–æ–ª—É—á–µ–Ω');
                return;
            }
            count += 5000;
            document.getElementById('score').innerText = count;
            localStorage.setItem(storageKey, count);
            localStorage.setItem(channelBonusKey, 'claimed');
            updateScoreOnServer();
            document.getElementById('channelBonusStatus').innerHTML = '‚úÖ +5000 AIR';
            tg.showAlert('üéâ +5000 AIR!');
        }

        function initReferrals() {
            if (!userId) return;
            let c = localStorage.getItem(referralCountKey);
            c = c ? parseInt(c) : 0;
            localStorage.setItem(referralCountKey, c);
            updateReferralUI();
            checkStartParam();
        }

        function checkStartParam() {
            const sp = initData.start_param;
            if (!sp || !sp.startsWith('ref_')) return;
            const rid = sp.replace('ref_', '');
            if (rid === userId.toString()) return;
            const key = `invited_${userId}_by_${rid}`;
            if (localStorage.getItem(key)) return;
            localStorage.setItem(key, 'true');
            let rc = localStorage.getItem(`referral_count_${rid}`);
            rc = rc ? parseInt(rc) + 1 : 1;
            localStorage.setItem(`referral_count_${rid}`, rc);
            checkAndAwardReferralBonus(rid, rc);
            tg.showAlert('üéâ –¢—ã –ø–æ —Å—Å—ã–ª–∫–µ –¥—Ä—É–≥–∞!');
        }

        function checkAndAwardReferralBonus(uid, cnt) {
            const rkey = `referral_rewards_${uid}`;
            let r = localStorage.getItem(rkey);
            r = r ? parseInt(r) : 0;
            const bt = Math.floor(cnt / 5);
            if (bt > r) {
                const bonus = (bt - r) * 500;
                const skey = `tap_score_${uid}`;
                let sc = localStorage.getItem(skey);
                sc = sc ? parseInt(sc) + bonus : bonus;
                localStorage.setItem(skey, sc);
                localStorage.setItem(rkey, bt.toString());
                if (uid == userId) {
                    count += bonus;
                    document.getElementById('score').innerText = count;
                    tg.showAlert(`üéâ +${bonus} AIR –∑–∞ –¥—Ä—É–∑–µ–π!`);
                }
            }
        }

        function updateReferralUI() {
            if (!userId) return;
            const cnt = parseInt(localStorage.getItem(referralCountKey) || '0');
            document.getElementById('referralCount').innerText = cnt;
            const next = (Math.floor(cnt / 5) + 1) * 5;
            document.getElementById('progressToNextBonus').innerText = `${cnt}/${next} –¥—Ä—É–∑–µ–π`;
            const link = `https://t.me/${BOT_USERNAME.replace('@','')}?start=ref_${userId}`;
            document.getElementById('referralLink').innerText = link;
            const rew = parseInt(localStorage.getItem(referralRewardsKey) || '0');
            const hist = document.getElementById('rewardsHistory');
            if (rew > 0) {
                let h = '';
                for (let i=1; i<=rew; i++) h += `üéÅ +500 AIR (${i*5})<br>`;
                hist.innerHTML = h;
            } else hist.innerHTML = '–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥';
        }

        function copyReferralLink() {
            const link = document.getElementById('referralLink').innerText;
            navigator.clipboard.writeText(link).then(() => tg.showAlert('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'));
        }

        function openBonuses() {
            document.getElementById('bonusScreen').classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
            updateDailyBonusUI();
        }

        function closeBonuses() {
            document.getElementById('bonusScreen').classList.remove('active');
        }

        function openFriends() {
            document.getElementById('friendsScreen').classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
            updateReferralUI();
        }

        function closeFriends() {
            document.getElementById('friendsScreen').classList.remove('active');
        }

        if (userId) {
            updateDailyBonusUI();
            initReferrals();
        }
    </script>
</body>
</html>